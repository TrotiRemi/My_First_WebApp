<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cloud School</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    :root{
      --beige: #f5ede3;
      --blue: #76c6ea; /* bleu ciel */
      --blue-strong: #2f97c1;
      --orange: #f28c28; /* pas trop clair */
      --text: #1f2937;
      --muted: #6b7280;
      --white: #ffffff;
      --shadow: 0 10px 25px rgba(0,0,0,0.08);
      --radius: 14px;
    }

    /* Global */
    html, body { height: 100%; }
    body {
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, Helvetica, sans-serif;
      margin: 0;
      color: var(--text);
      background: radial-gradient(1200px 800px at 80% -10%, rgba(118,198,234,0.25), transparent 60%),
                  linear-gradient(180deg, var(--beige), #fbf8f4);
    }
    .container { max-width: 1100px; margin: 0 auto; padding: 24px; }
    .hidden { display: none; }

    /* Header / Brand */
    .site-header {
      position: sticky; top: 0; z-index: 50;
      backdrop-filter: saturate(1.2) blur(6px);
      background: rgba(255,255,255,0.6);
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }
    .brand { display: flex; align-items: center; gap: 12px; padding: 14px 0; }
    .brand img { width: 40px; height: 40px; object-fit: contain; border-radius: 8px; background: linear-gradient(135deg, var(--blue) 0%, var(--orange) 100%); }
    .brand-name { font-weight: 800; letter-spacing: 0.3px; font-size: 1.25rem; color: #0f172a; }
    .brand-tag { color: var(--muted); font-size: 0.9rem; }

    /* Hero / Auth */
    .hero {
      display: grid; grid-template-columns: 1.2fr 1fr; gap: 30px; align-items: center; padding: 28px 0 8px;
    }
    .hero h1 { font-size: 2.2rem; margin: 0 0 10px; line-height: 1.2; }
    .hero p { color: var(--muted); margin: 0; }

    .auth-card {
      background: var(--white); border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 24px; border: 1px solid rgba(0,0,0,0.06);
      max-width: 100%;
      width: 100%;
    }
    .tabs { display: flex; gap: 6px; background: #f4f6f8; border-radius: 12px; padding: 6px; }
    .tab-btn {
      flex: 1; padding: 10px 12px; border-radius: 10px; border: none; background: transparent; cursor: pointer; font-weight: 600; color: #475569; font-size: 0.9rem;
    }
    .tab-btn.active { background: var(--blue); color: #073042; box-shadow: inset 0 0 0 2px rgba(0,0,0,0.05); }

    /* Forms */
    form { margin-top: 16px; }
    .form-group { margin-bottom: 16px; }
    label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; color: #334155; }
    input, select { width: 100%; padding: 12px 12px; border-radius: 10px; border: 1px solid #e5e7eb; background: #fbfbfb; outline: none; transition: box-shadow .2s, border-color .2s; font-size: 0.95rem; box-sizing: border-box; }
    input:focus, select:focus { border-color: var(--blue); box-shadow: 0 0 0 4px rgba(118,198,234,0.25); background: #fff; }

    .btn { padding: 12px 14px; border-radius: 10px; border: none; cursor: pointer; font-weight: 700; letter-spacing: .2px; }
    .btn-primary { background: linear-gradient(135deg, var(--blue-strong), var(--blue)); color: white; }
    .btn-primary:hover { filter: brightness(0.98); }
    .btn-ghost { background: transparent; color: #0f172a; border: 1px solid #e5e7eb; }
    .btn-ghost:hover { background: #f8fafc; }

    .muted { color: var(--muted); font-size: .9rem; }

    /* Course & Document cards (unchanged structure, subtle refresh for later views) */
    .course-card { border: 1px solid #e6e6e6; padding: 10px; margin: 10px 0; border-radius: 10px; background: #fff; cursor: pointer; transition: 0.2s; position: relative; box-shadow: var(--shadow); }
    .course-card:hover { transform: translateY(-2px); }
    .course-delete-btn { position: absolute; bottom: 8px; left: 8px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 26px; height: 26px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1; box-shadow: 0 6px 12px rgba(239,68,68,.25); }
    .course-card-compact { border: 1px solid #e6e6e6; padding: 12px; border-radius: 10px; background: #fff; cursor: pointer; transition: 0.2s; position: relative; min-width: 200px; max-width: 200px; flex: 0 0 200px; overflow: hidden; box-shadow: var(--shadow); }
    .course-card-compact:hover { transform: translateY(-2px); }
    .course-title-compact { font-weight: 800; margin-bottom: 6px; font-size: 0.98em; color: #0f172a; }
    .course-desc-compact { font-size: 0.82em; color: #6b7280; margin-bottom: 6px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; }
    .course-dates-compact { font-size: 0.75em; color: #94a3b8; }
    .course-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }

    .document-card { border: 1px solid #e6e6e6; padding: 12px; margin: 8px; border-radius: 10px; background: #fff; min-width: 200px; max-width: 200px; flex: 0 0 200px; overflow: hidden; position: relative; box-shadow: var(--shadow); }
    .document-delete-btn { position: absolute; bottom: 8px; left: 8px; background: #ef4444; color: white; border: none; border-radius: 50%; width: 26px; height: 26px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; padding: 0; line-height: 1; box-shadow: 0 6px 12px rgba(239,68,68,.25); }
  .document-title { font-weight: 800; color: var(--blue-strong); font-size: 0.9em; margin-bottom: 6px; }
    .document-link { color: var(--blue-strong); text-decoration: underline; cursor: pointer; }
    .documents-grid { display: flex; flex-wrap: wrap; gap: 10px; overflow-x: auto; padding: 10px 0; }
    .doc-type-section { margin-bottom: 25px; }
    .doc-type-title { font-weight: 800; font-size: 1em; color: #0f172a; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 2px solid var(--blue); }
    .doc-type-row { display: flex; flex-wrap: nowrap; gap: 8px; overflow-x: auto; padding: 8px 0; scroll-behavior: smooth; }
    .doc-type-row::-webkit-scrollbar { height: 6px; }
    .doc-type-row::-webkit-scrollbar-track { background: #eef2f7; border-radius: 3px; }
    .doc-type-row::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
    .doc-type-row::-webkit-scrollbar-thumb:hover { background: #64748b; }
    .add-doc-button { display: flex; flex-direction: column; align-items: center; justify-content: center; min-width: 150px; height: 150px; border: 2px dashed #cbd5e1; border-radius: 12px; background: #f8fafc; cursor: pointer; transition: 0.2s; font-size: 3em; color: #94a3b8; }
    .add-doc-button:hover { background: #eef2f7; color: #64748b; }

    .markdown-preview { background: white; padding: 15px; border-radius: 10px; margin: 10px 0; max-height: 300px; overflow-y: auto; font-size: 0.95em; line-height: 1.6; border: 1px solid #e5e7eb; }
    .markdown-preview h1, .markdown-preview h2, .markdown-preview h3 { margin: 15px 0 10px 0; font-weight: bold; }
    .markdown-preview blockquote { border-left: 4px solid var(--blue); padding-left: 10px; margin-left: 0; color: #475569; }
    .markdown-preview a { color: var(--blue-strong); text-decoration: underline; }

  /* Doc type visuals */
  .doc-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 6px; }
  .doc-left { display: flex; align-items: center; gap: 8px; min-width: 0; }
  .doc-icon { width: 22px; height: 22px; object-fit: contain; flex: 0 0 22px; }
  .doc-title-link { display: inline-block; max-width: 120px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .type-chip { font-size: 0.72rem; padding: 4px 8px; border-radius: 999px; border: 1px solid currentColor; white-space: nowrap; color: #64748b; background: #fff; }

    /* Modal Styles */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.hidden { display: none; }
    .modal { background: white; border-radius: 12px; padding: 30px; box-shadow: var(--shadow); max-width: 420px; text-align: center; border: 1px solid #e5e7eb; }
    .modal-title { font-size: 1.25em; font-weight: 800; margin-bottom: 15px; color: #0f172a; }
    .modal-message { font-size: 1em; color: #475569; margin-bottom: 25px; line-height: 1.5; }
    .modal-buttons { display: flex; gap: 10px; justify-content: center; }
    .modal-btn { padding: 10px 18px; border: none; border-radius: 10px; cursor: pointer; font-size: 1em; transition: 0.3s; font-weight: 700; }
    .modal-btn-cancel { background: #f1f5f9; color: #0f172a; border: 1px solid #e5e7eb; }
    .modal-btn-cancel:hover { background: #e2e8f0; }
    .modal-btn-confirm { background: #ef4444; color: white; }
    .modal-btn-confirm:hover { filter: brightness(.98); }

    /* Responsive */
    @media (max-width: 900px){
      .hero { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <!-- Modal de confirmation -->
  <div id="confirmation-modal" class="modal-overlay hidden" onclick="if(event.target.id === 'confirmation-modal') closeConfirmationModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-title" id="modal-title">Confirmation</div>
      <div class="modal-message" id="modal-message">√ätes-vous s√ªr ?</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeConfirmationModal()">Annuler</button>
        <button class="modal-btn modal-btn-confirm" onclick="confirmAction()">Supprimer</button>
      </div>
    </div>
  </div>

  <header class="site-header">
    <div class="container" style="display:flex; align-items:center; justify-content: space-between;">
      <div class="brand">
        <img id="brand-logo" src="IMG/logo.png" alt="Cloud School logo"
             onerror="this.onerror=null; this.src='data:image/svg+xml;utf8,\
             <svg xmlns=\'http://www.w3.org/2000/svg\' width=\'40\' height=\'40\' viewBox=\'0 0 64 64\'>\
               <defs><linearGradient id=\'g\' x1=\'0\' y1=\'0\' x2=\'1\' y2=\'1\'>\
                 <stop offset=\'0%\' stop-color=\'%2376c6ea\'/><stop offset=\'100%\' stop-color=\'%23f28c28\'/></linearGradient></defs>\
               <rect rx=\'12\' ry=\'12\' x=\'2\' y=\'2\' width=\'60\' height=\'60\' fill=\'url(%23g)\'/>\
               <circle cx=\'24\' cy=\'30\' r=\'10\' fill=\'%23ffffff\' fill-opacity=\'0.9\'/>\
               <ellipse cx=\'40\' cy=\'34\' rx=\'14\' ry=\'10\' fill=\'%23ffffff\' fill-opacity=\'0.9\'/>\
             </svg>';">
        <div>
          <div class="brand-name">Cloud School</div>
          <div class="brand-tag">Vos cours, documents et notes au m√™me endroit</div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <div id="forms">
    <section class="hero">
      <div>
        <h1>Organisez facilement votre vie scolaire</h1>
        <p class="muted">Connectez-vous ou cr√©ez un compte pour commencer √† g√©rer vos cours et documents.</p>
      </div>

      <div class="auth-card">
        <div class="tabs" role="tablist" aria-label="Connexion ou inscription">
          <button id="show-login" class="tab-btn active" role="tab" aria-selected="true">Se connecter</button>
          <button id="show-signup" class="tab-btn" role="tab" aria-selected="false">S'inscrire</button>
        </div>

        <form id="login-form">
          <div class="form-group">
            <label for="login-username">Nom d'utilisateur</label>
            <input id="login-username" placeholder="username" />
          </div>
          <div class="form-group">
            <label for="login-password">Mot de passe</label>
            <input id="login-password" placeholder="password" type="password" />
          </div>
          <button type="button" id="btn-login" class="btn btn-primary" style="width:100%">Se connecter</button>
          <pre id="login-result" class="muted" style="white-space:pre-wrap; margin-top:10px;"></pre>
        </form>

        <form id="signup-form" class="hidden">
          <div class="form-group">
            <label for="signup-username">Nom d'utilisateur</label>
            <input id="signup-username" placeholder="username" />
          </div>
          <div class="form-group">
            <label for="signup-email">Email</label>
            <input id="signup-email" placeholder="email" type="email" />
          </div>
          <div class="form-group">
            <label for="signup-password">Mot de passe</label>
            <input id="signup-password" placeholder="password" type="password" />
          </div>
          <button type="button" id="btn-signup" class="btn btn-primary" style="width:100%">Cr√©er un compte</button>
          <pre id="signup-result" class="muted" style="white-space:pre-wrap; margin-top:10px;"></pre>
        </form>
      </div>
    </section>
    </div>

  <div id="welcome" class="hidden">
      <div class="course-header">
        <div>
          <h2>Mes Cours</h2>
          <p id="welcome-msg"></p>
        </div>
        <div id="add-course-box" style="text-align: center; cursor: pointer;" onclick="showAddCourseForm()">
          <div class="add-doc-button" style="min-width: 120px; height: 120px; font-size: 2.5em;">+</div>
          <p style="margin-top: 10px; font-weight: bold; color: #333;">Rajouter un cours</p>
        </div>
      </div>
      
      <div id="courses-list" style="display: flex; flex-wrap: nowrap; gap: 8px; overflow-x: auto; padding: 10px 0; scroll-behavior: smooth;"></div>
      
      <button id="btn-logout" class="btn btn-ghost" style="margin-top: 20px;">Logout</button>
    </div>

    <div id="add-course-form" class="hidden">
      <button id="btn-back-to-courses-list" style="margin-bottom: 20px;">‚Üê Retour aux cours</button>
      <h2>Ajouter un cours</h2>
      
      <div class="form-group">
        <label>Titre du cours</label>
        <input id="course-title" placeholder="Ex: Math√©matiques" />
      </div>
      <div class="form-group">
        <label>Description</label>
        <input id="course-description" placeholder="Ex: Cours de maths niveau L1" />
      </div>
      <div class="form-group">
        <label>Date de d√©but</label>
        <input id="course-start" type="date" />
      </div>
      <div class="form-group">
        <label>Date de fin</label>
        <input id="course-end" type="date" />
      </div>
  <button id="btn-add-course" class="btn btn-primary">Ajouter un cours</button>
      
  <button id="btn-logout-courses" class="btn btn-ghost" style="margin-top: 20px;">Logout</button>
    </div>

    <div id="course-detail" class="hidden">
      <button id="btn-back-to-courses" style="margin-bottom: 20px;">‚Üê Retour aux cours</button>
      <div class="course-header">
        <div>
          <h2 id="detail-course-title"></h2>
          <p id="detail-course-desc"></p>
          <p id="detail-course-dates"></p>
        </div>
        <div id="add-doc-box" style="text-align: center; cursor: pointer;" onclick="showAddDocumentForm()">
          <div class="add-doc-button" style="min-width: 120px; height: 120px; font-size: 2.5em;">+</div>
          <p style="margin-top: 10px; font-weight: bold; color: #333;">Rajouter un doc</p>
        </div>
      </div>
      
      <h3>Documents du cours</h3>
      <div id="documents-list" class="documents-grid"></div>
      
  <button id="btn-logout-detail" class="btn btn-ghost" style="margin-top: 20px;">Logout</button>
    </div>

    <div id="add-document-form" class="hidden">
      <button id="btn-back-to-course" style="margin-bottom: 20px;">‚Üê Retour au cours</button>
      <h2>Ajouter un document</h2>
      
      <div class="form-group">
        <label>Titre du document</label>
        <input id="doc-title" placeholder="Ex: Cours chapitre 1" />
      </div>
      
      <div style="border: 2px dashed #ccc; padding: 15px; margin: 15px 0; border-radius: 5px; background: #fafafa;">
        <label style="display: block; margin-bottom: 10px;"><strong>üìÅ Uploader un fichier</strong></label>
        <input id="doc-file" type="file" />
      </div>
      
      <p style="font-size: 0.9em; color: #666; margin: 10px 0;">OU</p>
      
      <div class="form-group">
        <label>Lien URL (optionnel)</label>
        <input id="doc-url" type="url" placeholder="https://example.com/fichier.pdf" />
      </div>
      
      <div class="form-group">
        <label>Type</label>
        <select id="doc-type">
          <option value="">- Choisir -</option>
          <option value="cours">Cours</option>
          <option value="note_cours">Note cours</option>
          <option value="exercice">Exercice</option>
          <option value="correction_exercice">Correction d'exercice</option>
          <option value="tp_lab">TP/Lab</option>
          <option value="correction_tp_lab">Correction TP/Lab</option>
          <option value="partiel">Partiel</option>
          <option value="correction_partiel">Correction Partiel</option>
          <option value="info_cours">Info sur le cours</option>
        </select>
      </div>
  <button id="btn-add-document" class="btn btn-primary">Ajouter le document</button>
      
    <button id="btn-logout-add" class="btn btn-ghost" style="margin-top: 20px;">Logout</button>
    </div>

  </div>

  <script>
    const API_BASE = 'http://localhost:8000/api/v1';
    let currentCourseId = null;

    const showLoginBtn = document.getElementById('show-login');
    const showSignupBtn = document.getElementById('show-signup');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const welcome = document.getElementById('welcome');
    const courseDetail = document.getElementById('course-detail');
    const addDocumentForm = document.getElementById('add-document-form');
    const addCourseForm = document.getElementById('add-course-form');

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    function activateTab(isLogin){
      const loginTab = document.getElementById('show-login');
      const signupTab = document.getElementById('show-signup');
      if(isLogin){
        loginTab.classList.add('active');
        signupTab.classList.remove('active');
        show(loginForm); hide(signupForm);
      } else {
        signupTab.classList.add('active');
        loginTab.classList.remove('active');
        show(signupForm); hide(loginForm);
      }
    }

    showLoginBtn.onclick = () => activateTab(true);
    showSignupBtn.onclick = () => activateTab(false);

    async function login(){
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      const body = new URLSearchParams();
      body.append('username', username);
      body.append('password', password);

      const res = await fetch(API_BASE + '/auth/login', { method: 'POST', body, headers: { 'Content-Type': 'application/x-www-form-urlencoded' } });
      const data = await res.json();
      document.getElementById('login-result').textContent = JSON.stringify(data, null, 2);
      if(res.ok && data.access_token){
        localStorage.setItem('access_token', data.access_token);
        localStorage.setItem('username', username);
        showWelcome(username);
      }
    }

    async function signup(){
      const username = document.getElementById('signup-username').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const body = { username, email, password };

      const res = await fetch(API_BASE + '/auth/signup', { method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } });
      const data = await res.json();
      document.getElementById('signup-result').textContent = JSON.stringify(data, null, 2);
      if(res.ok){
        show(loginForm);
        hide(signupForm);
      }
    }

    async function showWelcome(username){
      hide(document.getElementById('forms'));
      hide(courseDetail);
      show(welcome);
      document.getElementById('welcome-msg').textContent = `Bonjour ${username} !`;
      loadCourses();
    }

    function showCourseDetail(courseId){
      currentCourseId = courseId;
      hide(welcome);
      hide(addDocumentForm);
      show(courseDetail);
      loadCourseDetail();
    }

    function showAddDocumentForm(){
      hide(courseDetail);
      show(addDocumentForm);
      // Reset form
      document.getElementById('doc-title').value = '';
      document.getElementById('doc-file').value = '';
      document.getElementById('doc-url').value = '';
      document.getElementById('doc-type').value = '';
    }

    function showAddCourseForm(){
      hide(welcome);
      show(addCourseForm);
      // Reset form
      document.getElementById('course-title').value = '';
      document.getElementById('course-description').value = '';
      document.getElementById('course-start').value = '';
      document.getElementById('course-end').value = '';
    }

    function backToCourseDetail(){
      hide(addDocumentForm);
      show(courseDetail);
      loadDocuments();
      setTimeout(loadMarkdownPreviews, 100);
    }

    function backToCoursesList(){
      hide(addCourseForm);
      show(welcome);
      loadCourses();
    }

    // Variables globales pour la modale
    let pendingDeleteAction = null;

    function showConfirmationModal(title, message, action) {
      document.getElementById('modal-title').textContent = title;
      document.getElementById('modal-message').textContent = message;
      pendingDeleteAction = action;
      document.getElementById('confirmation-modal').classList.remove('hidden');
    }

    function closeConfirmationModal() {
      document.getElementById('confirmation-modal').classList.add('hidden');
      pendingDeleteAction = null;
    }

    function confirmAction() {
      if (pendingDeleteAction) {
        pendingDeleteAction();
      }
      closeConfirmationModal();
    }

    function deleteCourse(event, courseId, courseName){
      event.stopPropagation();
      showConfirmationModal(
        'Supprimer le cours',
        `√ätes-vous s√ªr de vouloir supprimer le cours "${courseName}" ?`,
        function() {
          const token = localStorage.getItem('access_token');
          fetch(API_BASE + '/courses/' + courseId, { 
            method: 'DELETE', 
            headers: { 'Authorization': `Bearer ${token}` } 
          })
          .then(res => {
            if(res.ok){
              loadCourses();
            } else {
              alert('Erreur lors de la suppression du cours');
            }
          })
          .catch(e => console.error('Erreur:', e));
        }
      );
    }

    function deleteDocument(event, docId, docName){
      event.stopPropagation();
      showConfirmationModal(
        'Supprimer le document',
        `√ätes-vous s√ªr de vouloir supprimer le document "${docName}" ?`,
        function() {
          const token = localStorage.getItem('access_token');
          fetch(API_BASE + '/documents/' + docId, { 
            method: 'DELETE', 
            headers: { 'Authorization': `Bearer ${token}` } 
          })
          .then(res => {
            if(res.ok){
              loadDocuments();
            } else {
              alert('Erreur lors de la suppression du document');
            }
          })
          .catch(e => console.error('Erreur:', e));
        }
      );
    }

    async function loadCourseDetail(){
      const token = localStorage.getItem('access_token');
      try {
        const res = await fetch(API_BASE + '/courses/', { 
          headers: { 'Authorization': `Bearer ${token}` } 
        });
        if(res.ok){
          const courses = await res.json();
          const course = courses.find(c => c.id === currentCourseId);
          if(course){
            document.getElementById('detail-course-title').textContent = course.title;
            document.getElementById('detail-course-desc').textContent = course.description || '';
            const startDate = course.start_date ? new Date(course.start_date).toLocaleDateString('fr-FR') : '-';
            const endDate = course.end_date ? new Date(course.end_date).toLocaleDateString('fr-FR') : '-';
            document.getElementById('detail-course-dates').textContent = `Du ${startDate} au ${endDate}`;
            loadDocuments();
            setTimeout(loadMarkdownPreviews, 100);
          }
        }
      } catch(e) {
        console.error('Erreur:', e);
      }
    }

    async function addCourse(){
      const token = localStorage.getItem('access_token');
      const title = document.getElementById('course-title').value;
      const description = document.getElementById('course-description').value;
      const start = document.getElementById('course-start').value;
      const end = document.getElementById('course-end').value;

      if(!title){
        alert('Titre obligatoire');
        return;
      }

      const body = { title, description, start_date: start, end_date: end };
      const res = await fetch(API_BASE + '/courses/', { 
        method: 'POST', 
        body: JSON.stringify(body), 
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` } 
      });

      if(res.ok){
        backToCoursesList();
      } else {
        alert('Erreur lors de l\'ajout du cours');
      }
    }

    async function loadCourses(){
      const token = localStorage.getItem('access_token');
      try {
        const res = await fetch(API_BASE + '/courses/', { 
          headers: { 'Authorization': `Bearer ${token}` } 
        });

        if(res.ok){
          const courses = await res.json();
          const coursesList = document.getElementById('courses-list');
          coursesList.innerHTML = '';

          if(courses.length === 0){
            coursesList.innerHTML = '<p style="color: #999;">Aucun cours pour l\'instant</p>';
            return;
          }

          courses.forEach(course => {
            const card = document.createElement('div');
            card.className = 'course-card-compact';
            card.onclick = (e) => { if(e.target.closest('.course-delete-btn')) return; showCourseDetail(course.id); };
            const startDate = course.start_date ? new Date(course.start_date).toLocaleDateString('fr-FR') : '-';
            const endDate = course.end_date ? new Date(course.end_date).toLocaleDateString('fr-FR') : '-';
            card.innerHTML = `
              <button class="course-delete-btn" onclick="deleteCourse(event, ${course.id}, '${course.title}')">√ó</button>
              <div class="course-title-compact">${course.title}</div>
              <div class="course-desc-compact">${course.description || ''}</div>
              <div class="course-dates-compact">
                Du ${startDate} au ${endDate}
              </div>
            `;
            coursesList.appendChild(card);
          });
        } else {
          console.error('Erreur lors du chargement des cours:', res.status);
          document.getElementById('courses-list').innerHTML = '<p style="color: red;">Erreur lors du chargement</p>';
        }
      } catch(e) {
        console.error('Exception:', e);
        document.getElementById('courses-list').innerHTML = '<p style="color: red;">Erreur r√©seau</p>';
      }
    }

    async function addDocument(){
      const token = localStorage.getItem('access_token');
      const title = document.getElementById('doc-title').value;
      const url = document.getElementById('doc-url').value;
      const type = document.getElementById('doc-type').value;
      const file = document.getElementById('doc-file').files[0];

      if(!title){
        alert('Titre obligatoire');
        return;
      }

      // Si fichier upload√©
      if(file){
        const formData = new FormData();
        formData.append('file', file);
        formData.append('title', title);
        formData.append('doc_type', type);

        const res = await fetch(API_BASE + `/documents/upload/${currentCourseId}`, { 
          method: 'POST', 
          body: formData,
          headers: { 'Authorization': `Bearer ${token}` } 
        });

        if(res.ok){
          backToCourseDetail();
        } else {
          const data = await res.json();
          alert('Erreur: ' + (data.detail || 'Erreur inconnue'));
        }
      } 
      // Sinon URL externe
      else if(url){
        const body = { title, url, type, course_id: currentCourseId };
        const res = await fetch(API_BASE + '/documents/', { 
          method: 'POST', 
          body: JSON.stringify(body), 
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` } 
        });

        if(res.ok){
          backToCourseDetail();
        } else {
          const data = await res.json();
          alert('Erreur: ' + (data.detail || 'Erreur inconnue'));
        }
      }
      else {
        alert('Veuillez uploader un fichier ou fournir une URL');
      }
    }

    async function loadDocuments(){
      const token = localStorage.getItem('access_token');
      try {
        const res = await fetch(API_BASE + '/documents/course/' + currentCourseId, { 
          headers: { 'Authorization': `Bearer ${token}` } 
        });

        if(res.ok){
          const documents = await res.json();
          const docsList = document.getElementById('documents-list');
          docsList.innerHTML = '';

          if(documents.length === 0){
            docsList.innerHTML = '<p style="color: #999; padding: 20px;">Aucun document pour l\'instant</p>';
            return;
          }

          // D√©finir l'ordre des types
          const typeOrder = [
            'cours',
            'note_cours',
            'exercice',
            'correction_exercice',
            'tp_lab',
            'correction_tp_lab',
            'partiel',
            'correction_partiel',
            'info_cours'
          ];

          // Config: label, couleur, ic√¥ne
          const typeConfig = {
            'cours': { label: 'Cours', color: '#22c55e', icon: 'IMG/cours.png' },
            'note_cours': { label: 'Note cours', color: '#3b82f6', icon: 'IMG/Correction_Cours.png' },
            'exercice': { label: 'Exercice', color: '#f59e0b', icon: 'IMG/TD.png' },
            'correction_exercice': { label: "Correction d'exercice", color: '#f97316', icon: 'IMG/Correction_TD.png' },
            'tp_lab': { label: 'TP/Lab', color: '#8b5cf6', icon: 'IMG/tp_lab.png' },
            'correction_tp_lab': { label: 'Correction TP/Lab', color: '#a855f7', icon: 'IMG/correction_tp_lab.png' },
            'partiel': { label: 'Partiel', color: '#ef4444', icon: 'IMG/Partiel.png' },
            'correction_partiel': { label: 'Correction Partiel', color: '#dc2626', icon: 'IMG/Correction_partiel.png' },
            'info_cours': { label: 'Info sur le cours', color: '#06b6d4', icon: 'IMG/Info_Cours.png' },
            '': { label: 'Autres', color: '#64748b', icon: 'IMG/Info_Cours.png' }
          };
          const typeLabels = Object.fromEntries(Object.entries(typeConfig).map(([k,v]) => [k,v.label]));

          // Grouper les documents par type
          const groupedDocs = {};
          documents.forEach(doc => {
            const type = doc.type || '';
            console.log(`Doc: ${doc.title}, Type: "${type}"`);
            if (!groupedDocs[type]) {
              groupedDocs[type] = [];
            }
            groupedDocs[type].push(doc);
          });

          // Afficher par type dans l'ordre d√©fini
          typeOrder.forEach(type => {
            if (groupedDocs[type] && groupedDocs[type].length > 0) {
              const section = document.createElement('div');
              section.className = 'doc-type-section';
              
              const typeTitle = document.createElement('div');
              typeTitle.className = 'doc-type-title';
              typeTitle.textContent = typeLabels[type];
              section.appendChild(typeTitle);
              
              const row = document.createElement('div');
              row.className = 'doc-type-row';
              
              groupedDocs[type].forEach(doc => {
                const card = document.createElement('div');
                card.className = 'document-card';
                const conf = typeConfig[type] || typeConfig[''];
                card.style.borderLeft = `4px solid ${conf.color}`;
                
                // D√©terminer le type de fichier
                const url = doc.url;
                const ext = url.split('.').pop().toLowerCase();
                const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
                const isPdf = ext === 'pdf';
                const isMd = ext === 'md';
                const isText = ['txt', 'html'].includes(ext);
                const isWord = ['doc', 'docx'].includes(ext);
                
                let preview = '';
                if(isImage){
                  preview = `<img src="${url}" style="max-width: 100%; max-height: 120px; margin: 6px 0; border-radius: 5px; object-fit: cover;" />`;
                } else if(isPdf){
                  preview = `<iframe src="${url}" style="width: 100%; height: 120px; border: 1px solid #ddd; border-radius: 5px; margin: 6px 0;"></iframe>`;
                } else if(isMd){
                  preview = `<div class="markdown-preview" data-url="${url}" id="md-${doc.id}" style="max-height: 120px; padding: 8px; font-size: 0.8em;">Chargement...</div>`;
                } else if(isText){
                  preview = `<div style="background: white; padding: 8px; border-radius: 5px; margin: 6px 0; max-height: 120px; overflow-y: auto; font-family: monospace; font-size: 0.7em; white-space: pre-wrap; word-break: break-word; color: #333;"><iframe src="${url}" style="width: 100%; height: 100px; border: none; background: white;"></iframe></div>`;
                } else if(isWord){
                  preview = `<div style="background: white; padding: 8px; border-radius: 5px; margin: 6px 0; text-align: center; color: #666; font-size: 0.8em;"><p style="margin: 0;">üìÑ</p><p style="font-size: 0.7em; margin: 3px 0;">Word</p></div>`;
                } else {
                  preview = `<div style="background: white; padding: 8px; border-radius: 5px; margin: 6px 0; text-align: center; color: #666; font-size: 0.8em;"><p style="margin: 0;">üìé</p><p style="font-size: 0.7em; margin: 3px 0;">File</p></div>`;
                }
                
                card.innerHTML = `
                  <div class="doc-header">
                    <div class="doc-left">
                      <img class="doc-icon" src="${conf.icon}" alt="${conf.label}" onerror="this.style.display='none'"/>
                      <a href="${url}" target="_blank" class="document-link doc-title-link" title="${doc.title}">${doc.title}</a>
                    </div>
                    <span class="type-chip" style="color:${conf.color}">${conf.label}</span>
                  </div>
                  <button class="document-delete-btn" onclick="deleteDocument(event, ${doc.id}, '${doc.title}')">√ó</button>
                  ${preview}
                `;
                row.appendChild(card);
              });
              
              section.appendChild(row);
              docsList.appendChild(section);
            }
          });

          // Afficher les documents sans type
          if(groupedDocs[''] && groupedDocs[''].length > 0){
            const section = document.createElement('div');
            section.className = 'doc-type-section';
            
            const typeTitle = document.createElement('div');
            typeTitle.className = 'doc-type-title';
            typeTitle.textContent = 'Autres';
            section.appendChild(typeTitle);
            
            const row = document.createElement('div');
            row.className = 'doc-type-row';
            
            groupedDocs[''].forEach(doc => {
              const card = document.createElement('div');
              card.className = 'document-card';
              const conf = typeConfig[''];
              card.style.borderLeft = `4px solid ${conf.color}`;
              
              const url = doc.url;
              const ext = url.split('.').pop().toLowerCase();
              const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext);
              const isPdf = ext === 'pdf';
              const isMd = ext === 'md';
              const isText = ['txt', 'html'].includes(ext);
              const isWord = ['doc', 'docx'].includes(ext);
              
              let preview = '';
              if(isImage){
                preview = `<img src="${url}" style="max-width: 100%; max-height: 120px; margin: 6px 0; border-radius: 5px; object-fit: cover;" />`;
              } else if(isPdf){
                preview = `<iframe src="${url}" style="width: 100%; height: 120px; border: 1px solid #ddd; border-radius: 5px; margin: 6px 0;"></iframe>`;
              } else if(isMd){
                preview = `<div class="markdown-preview" data-url="${url}" id="md-${doc.id}" style="max-height: 120px; padding: 8px; font-size: 0.8em;">Chargement...</div>`;
              } else if(isText){
                preview = `<div style="background: white; padding: 8px; border-radius: 5px; margin: 6px 0; max-height: 120px; overflow-y: auto; font-family: monospace; font-size: 0.7em; white-space: pre-wrap; word-break: break-word; color: #333;"><iframe src="${url}" style="width: 100%; height: 100px; border: none; background: white;"></iframe></div>`;
              } else if(isWord){
                preview = `<div style="background: white; padding: 8px; border-radius: 5px; margin: 6px 0; text-align: center; color: #666; font-size: 0.8em;"><p style="margin: 0;">üìÑ</p><p style="font-size: 0.7em; margin: 3px 0;">Word</p></div>`;
              } else {
                preview = `<div style="background: white; padding: 8px; border-radius: 5px; margin: 6px 0; text-align: center; color: #666; font-size: 0.8em;"><p style="margin: 0;">üìé</p><p style="font-size: 0.7em; margin: 3px 0;">File</p></div>`;
              }
              
              card.innerHTML = `
                <div class="doc-header">
                  <div class="doc-left">
                    <img class="doc-icon" src="${conf.icon}" alt="${conf.label}" onerror="this.style.display='none'"/>
                    <a href="${url}" target="_blank" class="document-link doc-title-link" title="${doc.title}">${doc.title}</a>
                  </div>
                  <span class="type-chip" style="color:${conf.color}">${conf.label}</span>
                </div>
                <button class="document-delete-btn" onclick="deleteDocument(event, ${doc.id}, '${doc.title}')">√ó</button>
                ${preview}
              `;
              row.appendChild(card);
            });
            
            section.appendChild(row);
            docsList.appendChild(section);
          }
        } else {
          console.error('Erreur:', res.status);
        }
      } catch(e) {
        console.error('Erreur:', e);
      }
    }

    async function loadMarkdownPreviews(){
      const markdownDivs = document.querySelectorAll('.markdown-preview[data-url]');
      for(const div of markdownDivs){
        const url = div.getAttribute('data-url');
        try{
          const res = await fetch(url);
          const content = await res.text();
          const html = marked.parse(content);
          div.innerHTML = html;
        } catch(e){
          div.innerHTML = '<p style="color: red;">Erreur de chargement</p>';
        }
      }
    }

    async function logout(){
      const token = localStorage.getItem('access_token');
      await fetch(API_BASE + '/auth/logout', { 
        method: 'POST', 
        headers: { 'Authorization': `Bearer ${token}` } 
      });
      
      localStorage.removeItem('access_token');
      localStorage.removeItem('username');
      location.reload();
    }

    document.getElementById('btn-login').onclick = login;
    document.getElementById('btn-signup').onclick = signup;
    document.getElementById('btn-logout').onclick = logout;
    document.getElementById('btn-logout-detail').onclick = logout;
    document.getElementById('btn-logout-add').onclick = logout;
    document.getElementById('btn-logout-courses').onclick = logout;
    document.getElementById('btn-add-course').onclick = addCourse;
    document.getElementById('btn-add-document').onclick = addDocument;
    document.getElementById('btn-back-to-courses').onclick = () => showWelcome(localStorage.getItem('username'));
    document.getElementById('btn-back-to-course').onclick = backToCourseDetail;
    document.getElementById('btn-back-to-courses-list').onclick = backToCoursesList;

    // Si d√©j√† token -> afficher welcome
    const token = localStorage.getItem('access_token');
    const username = localStorage.getItem('username');
    if(token && username){
      showWelcome(username);
    } else {
      activateTab(true);
    }

    // Fermer modale avec Escape
    document.addEventListener('keydown', function(event) {
      if(event.key === 'Escape') {
        const modal = document.getElementById('confirmation-modal');
        if(!modal.classList.contains('hidden')) {
          closeConfirmationModal();
        }
      }
    });
  </script>
</body>
</html>