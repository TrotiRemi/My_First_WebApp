<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auth demo</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 20px; }
    .container { max-width: 420px; margin: 0 auto; }
    input { width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box; }
    button { padding: 8px 12px; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Auth demo</h1>

    <div id="forms">
      <div>
        <button id="show-login">Se connecter</button>
        <button id="show-signup">S'inscrire</button>
      </div>

      <form id="login-form" class="hidden">
        <h2>Login</h2>
        <input id="login-username" placeholder="username" />
        <input id="login-password" placeholder="password" type="password" />
        <button type="button" id="btn-login">Login</button>
        <pre id="login-result"></pre>
      </form>

      <form id="signup-form" class="hidden">
        <h2>Signup</h2>
        <input id="signup-username" placeholder="username" />
        <input id="signup-email" placeholder="email" />
        <input id="signup-password" placeholder="password" type="password" />
        <button type="button" id="btn-signup">Sign up</button>
        <pre id="signup-result"></pre>
      </form>
    </div>

    <div id="welcome" class="hidden">
      <h2>Bienvenue</h2>
      <p id="welcome-msg"></p>
      <button id="btn-logout">Logout</button>
    </div>

  </div>

  <script>
    const API_BASE = 'http://localhost:8000/api/v1';

    const showLoginBtn = document.getElementById('show-login');
    const showSignupBtn = document.getElementById('show-signup');
    const loginForm = document.getElementById('login-form');
    const signupForm = document.getElementById('signup-form');
    const welcome = document.getElementById('welcome');

    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }

    showLoginBtn.onclick = () => { show(loginForm); hide(signupForm); }
    showSignupBtn.onclick = () => { show(signupForm); hide(loginForm); }

    async function login(){
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      const body = new URLSearchParams();
      body.append('username', username);
      body.append('password', password);

      const res = await fetch(API_BASE + '/auth/login', { method: 'POST', body, headers: { 'Content-Type': 'application/x-www-form-urlencoded' } });
      const data = await res.json();
      document.getElementById('login-result').textContent = JSON.stringify(data, null, 2);
      if(res.ok && data.access_token){
        localStorage.setItem('access_token', data.access_token);
        localStorage.setItem('username', username);
        showWelcome(username);
      }
    }

    async function signup(){
      const username = document.getElementById('signup-username').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const body = { username, email, password };

      const res = await fetch(API_BASE + '/auth/signup', { method: 'POST', body: JSON.stringify(body), headers: { 'Content-Type': 'application/json' } });
      const data = await res.json();
      document.getElementById('signup-result').textContent = JSON.stringify(data, null, 2);
      if(res.ok){
        // auto-login after signup
        document.getElementById('login-username').value = username;
        document.getElementById('login-password').value = password;
        await login();
      }
    }

    function showWelcome(username){
      hide(document.getElementById('forms'));
      show(welcome);
      document.getElementById('welcome-msg').textContent = `Bonjour ${username} !`;
    }

    document.getElementById('btn-login').onclick = login;
    document.getElementById('btn-signup').onclick = signup;
    document.getElementById('btn-logout').onclick = () => {
      localStorage.removeItem('access_token');
      localStorage.removeItem('username');
      location.reload();
    };

    // Si déjà token -> afficher welcome
    const token = localStorage.getItem('access_token');
    const username = localStorage.getItem('username');
    if(token && username){
      showWelcome(username);
    } else {
      show(loginForm);
    }
  </script>
</body>
</html>